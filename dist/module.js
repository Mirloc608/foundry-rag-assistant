const h="foundry-rag-assistant",m={BACKEND_URL:"backendUrl",AUTH_TOKEN:"authToken"};function f(){return game.settings.get(h,m.BACKEND_URL).replace(/\/+$/,"")}function A(){const i=game.settings.get(h,m.AUTH_TOKEN);return(i==null?void 0:i.trim())||null}class k extends Application{static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"rag-control-panel",title:game.i18n.localize("RAG.PanelTitle"),template:"modules/foundry-rag-assistant/templates/rag-panel.hbs",width:420,height:"auto",resizable:!0})}async getData(){const t=f(),[n,e]=await Promise.all([this._fetchJSON(`${t}/chunks`),this._fetchJSON(`${t}/models`)]);return{chunks:(n==null?void 0:n.chunks)??[],models:(e==null?void 0:e.models)??[]}}async _fetchJSON(t,n={}){try{const e={...n.headers||{},"Content-Type":"application/json"},a=A();a&&(e.Authorization=`Bearer ${a}`);const s=await fetch(t,{...n,headers:e,credentials:"include"});return s.ok?await s.json():(console.warn("RAG request failed",t,s.status),null)}catch(e){return console.error("RAG request error",t,e),null}}activateListeners(t){super.activateListeners(t),t.find("[data-action='refresh']").on("click",n=>{n.preventDefault(),this.render(!0)}),t.find("[data-action='ingest-url']").on("click",async n=>{var r,c,u,o;n.preventDefault();const a=(r=t.find("input[name='ingest-url']").val())==null?void 0:r.trim();if(!a){(c=ui.notifications)==null||c.warn("RAG: Please enter a URL to ingest.");return}const s=(u=game.scenes)==null?void 0:u.current,l=f();await this._fetchJSON(`${l}/ingest`,{method:"POST",body:JSON.stringify({url:a,sceneId:s==null?void 0:s.id})}),(o=ui.notifications)==null||o.info("RAG: URL ingested."),this.render(!0)}),t.find("[data-action='ingest-journals']").on("click",async n=>{var l,r,c,u;n.preventDefault();const e=(l=game.scenes)==null?void 0:l.current,a=((r=game.journal)==null?void 0:r.contents)??[];if(!a.length){(c=ui.notifications)==null||c.warn("RAG: No journals found to ingest.");return}const s=f();for(const o of a){const g=(o.pages??[]).map(d=>{var p;return((p=d.text)==null?void 0:p.content)??""}).filter(d=>!!d).join(`

`);g&&await this._fetchJSON(`${s}/ingest/journal`,{method:"POST",body:JSON.stringify({id:o.id,name:o.name,text:g,sceneId:e==null?void 0:e.id})})}(u=ui.notifications)==null||u.info("RAG: Journals ingested.")})}}Hooks.once("init",()=>{console.log("Foundry RAG Assistant | Initializing")});Hooks.on("getSceneControlButtons",i=>{const t=i.find(n=>n.name==="token");t&&t.tools.push({name:"rag-panel",title:"RAG Assistant",icon:"fas fa-brain",button:!0,onClick:()=>{new k().render(!0)}})});
//# sourceMappingURL=module.js.map
