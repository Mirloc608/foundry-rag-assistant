{"version":3,"file":"module.js","sources":["../src/settings.ts","../src/ragPanel.ts","../src/module.ts"],"sourcesContent":["export const MODULE_ID = \"foundry-rag-assistant\";\r\n\r\nexport const SETTINGS = {\r\n  BACKEND_URL: \"backendUrl\",\r\n  AUTH_TOKEN: \"authToken\"\r\n} as const;\r\n\r\nexport function registerSettings() {\r\n  game.settings.register(MODULE_ID, SETTINGS.BACKEND_URL, {\r\n    name: \"RAG.Setting.BackendURL\",\r\n    hint: \"RAG.Setting.BackendURL.Hint\",\r\n    scope: \"world\",\r\n    config: true,\r\n    type: String,\r\n    default: \"https://foundry.dmathome.com/rag\",\r\n    requiresReload: true\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, SETTINGS.AUTH_TOKEN, {\r\n    name: \"RAG.Setting.AuthToken\",\r\n    hint: \"RAG.Setting.AuthToken.Hint\",\r\n    scope: \"world\",\r\n    config: true,\r\n    type: String,\r\n    default: \"\",\r\n    requiresReload: false\r\n  });\r\n}\r\n\r\nexport function getBackendBase(): string {\r\n  return (game.settings.get(MODULE_ID, SETTINGS.BACKEND_URL) as string).replace(/\\/+$/, \"\");\r\n}\r\n\r\nexport function getAuthToken(): string | null {\r\n  const v = game.settings.get(MODULE_ID, SETTINGS.AUTH_TOKEN) as string;\r\n  return v?.trim() || null;\r\n}\r\n","import { getBackendBase, getAuthToken } from \"./settings\";\r\n\r\ninterface RagChunk {\r\n  payload: any;\r\n  score: number;\r\n}\r\n\r\ninterface RagModelsResponse {\r\n  models: string[];\r\n}\r\n\r\ninterface RagChunksResponse {\r\n  chunks: RagChunk[];\r\n}\r\n\r\nexport class RagControlPanel extends Application {\r\n  static get defaultOptions() {\r\n    return mergeObject(super.defaultOptions, {\r\n      id: \"rag-control-panel\",\r\n      title: game.i18n.localize(\"RAG.PanelTitle\"),\r\n      template: \"modules/foundry-rag-assistant/templates/rag-panel.hbs\",\r\n      width: 420,\r\n      height: \"auto\",\r\n      resizable: true\r\n    });\r\n  }\r\n\r\n  async getData() {\r\n    const base = getBackendBase();\r\n    const [chunksResp, modelsResp] = await Promise.all([\r\n      this._fetchJSON<RagChunksResponse>(`${base}/chunks`),\r\n      this._fetchJSON<RagModelsResponse>(`${base}/models`)\r\n    ]);\r\n\r\n    return {\r\n      chunks: chunksResp?.chunks ?? [],\r\n      models: modelsResp?.models ?? []\r\n    };\r\n  }\r\n\r\n  private async _fetchJSON<T>(url: string, options: RequestInit = {}): Promise<T | null> {\r\n    try {\r\n      const headers: HeadersInit = { ...(options.headers || {}), \"Content-Type\": \"application/json\" };\r\n      const token = getAuthToken();\r\n      if (token) headers[\"Authorization\"] = `Bearer ${token}`;\r\n\r\n      const resp = await fetch(url, {\r\n        ...options,\r\n        headers,\r\n        credentials: \"include\"\r\n      });\r\n      if (!resp.ok) {\r\n        console.warn(\"RAG request failed\", url, resp.status);\r\n        return null;\r\n      }\r\n      return (await resp.json()) as T;\r\n    } catch (err) {\r\n      console.error(\"RAG request error\", url, err);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  activateListeners(html: JQuery) {\r\n    super.activateListeners(html);\r\n\r\n    html.find(\"[data-action='refresh']\").on(\"click\", ev => {\r\n      ev.preventDefault();\r\n      this.render(true);\r\n    });\r\n\r\n    html.find(\"[data-action='ingest-url']\").on(\"click\", async ev => {\r\n      ev.preventDefault();\r\n      const input = html.find(\"input[name='ingest-url']\");\r\n      const url = (input.val() as string)?.trim();\r\n      if (!url) {\r\n        ui.notifications?.warn(\"RAG: Please enter a URL to ingest.\");\r\n        return;\r\n      }\r\n\r\n      const scene = game.scenes?.current;\r\n      const base = getBackendBase();\r\n      await this._fetchJSON(`${base}/ingest`, {\r\n        method: \"POST\",\r\n        body: JSON.stringify({ url, sceneId: scene?.id })\r\n      });\r\n\r\n      ui.notifications?.info(\"RAG: URL ingested.\");\r\n      this.render(true);\r\n    });\r\n\r\n    html.find(\"[data-action='ingest-journals']\").on(\"click\", async ev => {\r\n      ev.preventDefault();\r\n      const scene = game.scenes?.current;\r\n      const journals = game.journal?.contents ?? [];\r\n      if (!journals.length) {\r\n        ui.notifications?.warn(\"RAG: No journals found to ingest.\");\r\n        return;\r\n      }\r\n\r\n      const base = getBackendBase();\r\n      for (const j of journals) {\r\n        const pages = (j as any).pages ?? [];\r\n        const text = pages\r\n          .map((p: any) => p.text?.content ?? \"\")\r\n          .filter((t: string) => !!t)\r\n          .join(\"\\n\\n\");\r\n        if (!text) continue;\r\n\r\n        await this._fetchJSON(`${base}/ingest/journal`, {\r\n          method: \"POST\",\r\n          body: JSON.stringify({\r\n            id: j.id,\r\n            name: j.name,\r\n            text,\r\n            sceneId: scene?.id\r\n          })\r\n        });\r\n      }\r\n\r\n      ui.notifications?.info(\"RAG: Journals ingested.\");\r\n    });\r\n  }\r\n}\r\n","import { RagControlPanel } from \"./ragPanel\";\r\n\r\nHooks.once(\"init\", () => {\r\n  console.log(\"Foundry RAG Assistant | Initializing\");\r\n});\r\n\r\nHooks.on(\"getSceneControlButtons\", (controls: any[]) => {\r\n  const tokenControls = controls.find(c => c.name === \"token\");\r\n  if (!tokenControls) return;\r\n\r\n  tokenControls.tools.push({\r\n    name: \"rag-panel\",\r\n    title: \"RAG Assistant\",\r\n    icon: \"fas fa-brain\",\r\n    button: true,\r\n    onClick: () => {\r\n      const app = new RagControlPanel();\r\n      app.render(true);\r\n    }\r\n  });\r\n});\r\n"],"names":["MODULE_ID","SETTINGS","getBackendBase","getAuthToken","v","RagControlPanel","base","chunksResp","modelsResp","url","options","headers","token","resp","err","html","ev","_a","_b","_c","_d","scene","journals","j","text","p","t","controls","tokenControls","c"],"mappings":"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"}